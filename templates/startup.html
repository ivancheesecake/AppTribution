<!-- API Key: AIzaSyCJ5WBMO5HtCfyHWB-XC-fwNHl0fg1HYzY -->

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AppTribution | An App for Attribution Using Google Street View</title>
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="{{url_for('static',filename='css/startup.css')}}?q=1280549780" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="{{url_for('static',filename='css/materialize.css')}}?q=1280549780"  media="screen,projection"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  </head>
  <body>
    <header>

      <nav>
        <div class="nav-wrapper light-blue darken-4">
          <a href="#" class="brand-logo">&nbsp;&nbsp;AppTribution</a>
        </div>
      </nav>  
        
    </header>
    <main>
      <div class="row">
        <div class="col s3 m3 l3 center-align" id="left">
          <img id="icon-big" class="responsive-img center-align" src="{{url_for('static',filename='img/appicon-circle.png')}}?q=1280549780" />
          <h5>Create New Attribution Project</h5>
          <br />

          <div class="input-field col s12">
            <input placeholder="i.e. SanCristobal_Blk12" id="proj_name" type="text">
            <label for="proj_name">Project Name</label>
          </div>

          <div class="input-field col s12">
            <select id="river_basin">
              <optgroup label="Laguna">
                <option value="Pagsanjan">Pagsanjan</option>
                <option value="San Cristobal">San Cristobal</option>
                <option value="Sta. Cruz">Sta. Cruz</option>
              </optgroup>
              <optgroup label="Occidental Mindoro">
                <option value="Abra de Ilog">Abra de Ilog</option>
                <option value="Amnay">Amnay</option>
                <option value="Anahawin">Anahawin</option>
                <option value="Caguray">Caguray</option>
                <option value="Ibod">Ibod</option>
                <option value="Labangan">Labangan</option>
                <option value="Lunintao">Lunintao</option>
                <option value="Magbando">Magbando</option>
                <option value="Mamburao">Mamburao</option>
                <option value="Monpong">Monpong</option>
                <option value="Pagbahan">Pagbahan</option>
                <option value="Pola">Pola</option>
              </optgroup>
              <optgroup label="Oriental Mindoro">
                <option value="Agsalin">Agsalin</option>
                <option value="Bansud">Bansud</option>
                <option value="Baroc">Baroc</option>
                <option value="Ibod">Ibod</option>
                <option value="Bongabong">Bongabong</option>
                <option value="Bulalacao">Bulalacao</option>
                <option value="Butas">Butas</option>
                <option value="Casiligan">Casiligan</option>
                <option value="Sumagui">Sumagui</option>
              </optgroup>
              <optgroup label="Marinduque">
                <option value="Boac">Boac</option>
                <option value="Tawiran Tagum">Tawiran Tagum</option>
              </optgroup>
              <optgroup label="Palawan">
                <option value="Abongan">Abongan</option>
                <option value="Aborlan">Aborlan</option>
                <option value="Babuyan">Babuyan</option>
                <option value="Bacungan">Bacungan</option>
                <option value="Batang Batang">Batang Batang</option>
                <option value="Caramay">Caramay</option>
                <option value="Ilog Ilog">Ilog Ilog</option>
                <option value="Inagauan">Inagauan</option>
                <option value="Iraan">Iraan</option>
                <option value="Iwahig">Iwahig</option>
                <option value="Iwahig Brookes">Iwahig Brookes</option>
                <option value="Iwahig Penal">Iwahig Penal</option>
                <option value="Langogan">Langogan</option>
                <option value="Malambunga">Malambunga</option>
                <option value="Malasgao">Malasgao</option>
                <option value="Okayan">Okayan</option>
                <option value="Panitian">Panitian</option>
                <option value="Pulot">Pulot</option>
                <option value="Ransang">Ransang</option>
                <option value="Tiga Plan">Tiga Plan</option>
              </optgroup>


            </select>
            <label>River Basin</label>
          </div>

          <div class="input-field col s12">
                <select id="in_charge">
                  <option value="Unassigned">Unassigned</option>
                  <option value="Allen Jay">Allen Jay</option>
                  <option value="Allen Roy">Allen Roy</option>
                  <option value="Dop">Dop</option>
                  <option value="Evan">Evan</option>
                  <option value="Gelo">Gelo</option>
                  <option value="Ivan">Ivan</option>
                  <option value="Jon">Jon</option>
                  <option value="Tim">Tim</option>
                  <option value="Dan">Dan</option>
                  <option value="Raymund">Raymund</option>
                  <option value="Axel">Axel</option>
                  <option value="Tristan">Tristan</option>
                  <option value="Ryn">Ryn</option>
                  <option value="Paulo">Paulo</option>
                  <option value="Kuya Randy">Kuya Randy</option>
                  <option value="Ralph">Ralph</option>
                  
                  
                  </select>
                  <label>Person-in-Charge</label>
          </div>


          <div class="file-field input-field col s12">
            <div class="btn">
              <span>File</span>
              <input id="kml-points" type="file">
            </div>
            <div class="file-path-wrapper">
              <input class="file-path validate" type="text" placeholder="Point Feature KML"> <!--Add name later-->
            </div>
          </div>

          <a id="create-project"class="waves-effect waves-light green btn-large"><i class="material-icons left">add</i>create project</a>

        </div>

        <div class="col s9 m9 l9" id="right">
          <div class="row">
            <h3>Load Existing Project</h3>
          </div>
          <div class="row">
            <div class="col s6 m6 l6">
              <div class="input-field col s12">
                <input placeholder="i.e. Project Name, River Basin, etc." id="filter_keyword" type="text">
                <label for="proj_name">Search Keyword</label>
              </div>
            </div>

            <div class="col s4 m4 l4">

               <div class="input-field col s12">
                <select id="filter_in_charge">
                  <option value=""></option>
                  <option value="Unassigned">Unassigned</option>
                  <option value="Allen Jay">Allen Jay</option>
                  <option value="Allen Roy">Allen Roy</option>
                  <option value="Dop">Dop</option>
                  <option value="Evan">Evan</option>
                  <option value="Gelo">Gelo</option>
                  <option value="Ivan">Ivan</option>
                  <option value="Jon">Jon</option>
                  <option value="Tim">Tim</option>
                  <option value="Dan">Dan</option>
                  <option value="Raymund">Raymund</option>
                  <option value="Axel">Axel</option>
                  <option value="Tristan">Tristan</option>
                  <option value="Ryn">Ryn</option>
                  <option value="Paulo">Paulo</option>
                  <option value="Kuya Randy">Kuya Randy</option>
                  <option value="Ralph">Ralph</option>
                  
                  </select>
                  <label>Person-in-Charge</label>
                </div>

            </div>

            <div class="col s2 m2 l2">

               <p>
                <input type="checkbox" class="filled-in" id="filter_finished"  />
                <label for="filter_finished" style="font-size:11px; margin-top: 10px">Show Finished</label>
              </p>

            </div>

          </div>
          <div class="row" id="projects">
            <!-- <div class="card col s3">
              <div class="card-image green">
                <img src="{{url_for('static',filename='img/blank.png')}}?q=1280549780">
                <br/>
                <span class="card-title">Iwahig Brookes Blk 1</span>
              </div>
              <div class="card-content">
                
                  <div class="col s9 m9 l9">
                    <p>River Basin: Iwahig Brookes</p>
                    <p>In Charge: Ivan</p>
                  </div>
                  <div class="col s3 m3 l3 card-fab-wrapper" >


                      <div class="fixed-action-btn horizontal card-fab" >
                        <a class="btn-floating btn-large red" href="/edit?project=1" >
                          <i class="large material-icons">mode_edit</i>
                        </a>
                        <ul>
                          <li><a class="delete-project btn-floating red" data-projectid="1"><i class="material-icons">delete</i></a></li>
                          <li><a class="export-project btn-floating green" data-projectid="1"><i class="material-icons">file_download</i></a></li></a>
                      
                        </ul>
                      </div> 
                    </div>
                  
              </div>
            </div> -->

          </div>


        </div>

      </div>

      <!-- Modal Structure -->
    <div id="assign-modal" class="modal">
      <div class="modal-content">
        <h4>Assign Project</h4>
        <br />
        <div class="input-field col s12">
          <select id="assign_in_charge">
            
            <option value="Allen Jay">Allen Jay</option>
            <option value="Allen Roy">Allen Roy</option>
            <option value="Dop">Dop</option>
            <option value="Evan">Evan</option>
            <option value="Gelo">Gelo</option>
            <option value="Ivan">Ivan</option>
            <option value="Jon">Jon</option>
            <option value="Tim">Tim</option>
            <option value="Dan">Dan</option>
            <option value="Raymund">Raymund</option>
            <option value="Axel">Axel</option>
            <option value="Tristan">Tristan</option>
            <option value="Ryn">Ryn</option>
            <option value="Paulo">Paulo</option>
            <option value="Kuya Randy">Kuya Randy</option>
            <option value="Ralph">Ralph</option>
                  
          </select>
          <label>Person-in-Charge</label>
        </div>
        <br />
        <br />
        <br />
      </div>
      <div class="modal-footer">
        <a href="#!" id="assign" class=" modal-action modal-close waves-effect waves-green btn-flat">Assign</a>
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Cancel</a>
      </div>
    </div>

    </main>

    <footer class="page-footer light-blue darken-4">
      <div class="footer-copyright">
        <div class="container  center-align">
          <a class="white-text text-lighten-3" href="">&copy;2017 University of the Philippines Los Baños Phil-LiDAR 1</a>
        </div>
      </div>
    </footer>
    
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="{{url_for('static',filename='js/materialize.min.js')}}?q=1280549780"></script>

    <script type="text/javascript">
     
      // function renderProjects(projects){
      //   $("#projects").html("")
      //   for(var i=0; i<response.length; i++){
      //         console.log("HERE");

      //         $("#projects").append('<div class="card col s3"><div class="card-image green"><img src="{{url_for("static",filename="img/blank.png")}}?q=1280549780"><br/><span class="card-title">'+response[i].project_name+'</span><a class="btn-floating halfway-fab waves-effect waves-light red" href="/edit?project='+response[i].project_id+'"><i class="material-icons">edit</i></a></div><div class="card-content"><p>River Basin:'+response[i].river_basin+'</p><p>In Charge:'+response[i].in_charge+'</p></div></div>');
      //       }
      // }

      function renderProjects(response){
        $("#projects").html("");
        // $("#filter_in_charge").val("");
        // $('#filter_in_charge').material_select();
        // $("#filter_keyword").val("");
        for(var i=0; i<response.length; i++){
              console.log("HERE");
              color = "yellow darken-3"
              if(response[i].finished){
                status = "Finished";
                color = "green"
                }
              else
                status = "Working";
 

              if(response[i].in_charge=="Unassigned"){
                color = "grey darken-3"
                status = ""
              }
              

              $("#projects").append('<div id="project'+response[i].project_id+'"class="card col s3"><div class="card-image '+color+'"><img src="{{url_for("static",filename="img/blank.png")}}?q=1280549780"><br/><span class="card-title">'+response[i].project_name+'</span></div><div class="card-content"><div style="text-overflow:ellipsis" class="col s9 m9 l9"><p>River Basin: '+response[i].river_basin+'</p><p>In Charge: '+response[i].in_charge+'</p><p>Status: '+status+'</p></div><div class="col s3 m3 l3 card-fab-wrapper" ><div class="fixed-action-btn horizontal card-fab" ><a class="btn-floating btn-large red" href="/edit?project='+response[i].project_id+'" ><i class="large material-icons">mode_edit</i></a><ul><li class="btn-adjust"><a title="Delete Project" class="delete-project btn-floating btn-small red" data-projectid="'+response[i].project_id+'"><i class="material-icons">delete</i></a></li><li class="btn-adjust"><a title="Export Project" class="export-project btn-floating btn-small green" data-projectid="'+response[i].project_id+'"><i class="material-icons">file_download</i></a></li><li class="btn-adjust"><a title="Mark as Finished" class="mark-finished btn-floating btn-small purple darken-1" data-projectid="'+response[i].project_id+'"><i class="material-icons">check</i></a></li><li class="btn-adjust"><a href="#assign-modal" title="Assign to User" class="assign-project btn-floating btn-small yellow darken-1" data-projectid="'+response[i].project_id+'"><i class="material-icons">person</i></a></li></a></ul></div></div></div></div>').hide().fadeIn('300');
            }

        // Add listeners here
        $(".export-project").click(function(event) {
       
          // console.log($(this).data("projectid"));
            $.ajax({
              url: '/export',
              type: 'POST',
              dataType: 'json',
              data: {'project_id': $(this).data("projectid")},
              success:function(response) {
                Materialize.toast('Project Successfully Exported.', 4000,'green lighten-1')

              }
            })
            .done(function() {
              console.log("success");
            })
            .fail(function() {
              console.log("error");
            })
            .always(function() {
              console.log("complete");
            });
        });

        $(".delete-project").click(function(event) {
       
          // console.log($(this).data("projectid"));
          r = confirm("Are you sure you want to delete this project?");
          if(r == true) {
            $.ajax({
                url: '/delete',
                type: 'POST',
                dataType: 'json',
                data: {'project_id': $(this).data("projectid")},
                success:function(response) {
                  projects = checkFinished(response);
                  Materialize.toast('Project Successfully Deleted.', 4000,'green lighten-1');
                  renderProjects(projects); 
                  filterProjects(projects);
                }
              })
              .done(function() {
                console.log("success");
              })
              .fail(function() {
                console.log("error");
              })
              .always(function() {
                console.log("complete");
              });
          }
        });

        $(".assign-project").click(function(event) {
           $("#assign").data("projectid",$(this).data("projectid"));
        });

        $(".mark-finished").click(function(event) {
       
          r = confirm("Are you sure you want to mark this project as finished?");
          if(r == true) {
            $.ajax({
                url: '/mark_finished',
                type: 'POST',
                dataType: 'json',
                data: {'project_id': $(this).data("projectid")},
                success:function(response) {
                  projects = checkFinished(response);
                  Materialize.toast('Project Successfully Marked as Finished.', 4000,'green lighten-1');
                  renderProjects(projects);
                  filterProjects(projects) 
                  // console.log("EYY");
                }
              })
              .done(function() {
                console.log("success");
              })
              .fail(function() {
                console.log("error");
              })
              .always(function() {
                console.log("complete");
              });
            }
         
        });

      }

      $(document).ready(function() {

        // Initialize Modal

        $('#assign-modal').modal();

        h_test = $('header').height() + parseInt($('div#right').css("padding-top")) + parseInt($('div#right>div>h3').css("margin-top")) + $('div#right>div').height() + parseInt($('div#right>div').css("margin-bottom")) + $('div#right div:eq(1)').height() + parseInt($('div#right div:eq(1)').css("margin-bottom"));
        console.log(h_test);
        // h_test = 281.9;
        h_test = $(window).height() - h_test;
        console.log(h_test);
        $("div#projects").css("overflow-y", "scroll");
        $("div#projects").css("height", h_test + "px");

        projects = []
        $('select').material_select();

        $.ajax({
          url: '/fetch_projects',
          type: 'POST',
          dataType: 'json',
          data: {'msg': 'hey'},
          success:function(response) {

            projects = checkFinished(response);

            for(var i=0;i<projects.length; i++){
              projects[i].keywords = projects[i].project_name.toLowerCase() + " " + projects[i].river_basin.toLowerCase() + " " + projects[i].in_charge.toLowerCase();
            }

            renderProjects(projects);
            filterProjects(projects)
            // for (var i=0;i<projects.length;i++){
            //   if (projects[i].finished) {
            //         $("#project"+projects[i].project_id).hide();

            //     }
            // }           

          }
        })
        .done(function() {
          console.log("success");
        })
        .fail(function() {
          console.log("error");
        })
        .always(function() {
          console.log("complete");
          
        });
        
        $("#kml-points").change(function(event) {
          // console.log($("#kml-points").val())
          path = $("#kml-points").val();
          length = path.length-3
          console.log(path.substring(12,path.length-4))
          $("#proj_name").val(path.substring(12,path.length-4));
        });

        $("#filter_in_charge, #filter_keyword, #filter_finished").on('input change',function(event) {
          
          filterProjects(projects);
          console.log("AYO GG");
        });
        
      });

      $('#create-project').click(function(event) {

        var fileInput = document.getElementById('kml-points');
        var file = fileInput.files[0];
        console.log(file);
        var reader = new FileReader();
        reader.readAsText(file)
        reader.onload = function(e){

          project_name = $("#proj_name").val();
          river_basin = $("#river_basin").val();
          in_charge = $("#in_charge").val();

          console.log(project_name);
          console.log(river_basin);
          console.log(in_charge);
          var kml_data = reader.result;
          $.ajax({
            url: '/create_project',
            type: 'POST',
            dataType: 'json',
            data: {"project_name": project_name, "river_basin":river_basin,"kml_data":kml_data,"in_charge":in_charge},
            success: function(response){
              //Alertify
              //
              projects = checkFinished(response);
             
              
              renderProjects(projects)
              filterProjects(projects)
              Materialize.toast('Project Successfully Created.', 4000,'green lighten-1') 
            }
          });
          
        }
        
      });

      // Assign Project

      $("#assign").click(function(event) {
       
          console.log("Assign!");
          console.log($(this).data("projectid"));
          // r = confirm("Are you sure you want to delete this project?");
          // if(r == true) {
          $.ajax({
              url: '/assign_project',
              type: 'POST',
              dataType: 'json',
              data: {'project_id': $(this).data("projectid"),'in_charge':$("#assign_in_charge").val()},
              success:function(response) {
                projects = checkFinished(response);
                Materialize.toast('Project Successfully Updated.', 4000,'green lighten-1');
                renderProjects(projects) ; 
                filterProjects(projects)
              }
            })
            .done(function() {
              console.log("success");
            })
            .fail(function() {
              console.log("error");
            })
            .always(function() {
              console.log("complete");
            });
          // }
        });

      // Check for finished

      function checkFinished(projects){

        for(i=0; i<projects.length; i++){

          projects[i].finished = false;

          if (projects[i].project_name[0] == "*"){
            projects[i].finished = true;
            projects[i].project_name = projects[i].project_name.substr(1,projects[i].project_name.length)
          }

        }

        return projects;
      }

      function filterProjects(projects){
        in_charge = $("#filter_in_charge").val();
          keyword = $("#filter_keyword").val().toLowerCase();
          view_finished = $('#filter_finished').is(":checked")
          console.log(view_finished)
          for(var i=0; i<projects.length; i++){
            $("#project"+projects[i].project_id).show();
          }

          for(var i=0; i<projects.length; i++){
              // console.log(projects[i].in_charge)
            // Filter by in-charge
            if(in_charge!=""){
              if (projects[i].in_charge!=in_charge){
                $("#project"+projects[i].project_id).hide();
              }
            }

            if(keyword!=""){
              if (!projects[i].keywords.match(keyword)) {
                  $("#project"+projects[i].project_id).hide();

              }
            }
            // console.log(projects[i].finished)
            if(!view_finished){
              if (projects[i].finished) {
                  $("#project"+projects[i].project_id).hide();

              }
            }
          }
        }
          
    </script>
  </body>
</html>